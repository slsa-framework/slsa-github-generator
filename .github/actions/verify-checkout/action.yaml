name: "Verify a checkout's sha"
description: "verify commit sha for a GitHub repo"

runs:
  using: "composite"
  steps:
    - name: Verify commit sha
      shell: bash
      env:
        GITHUB_CONTEXT: "${{ toJSON(github) }}"
        PULL_REQUEST_SHA: "${{ github.event.pull_request.head.sha }}"
      run: |
        set -euo pipefail

        git_sha="$(git log -1 --format='%H')"
        github_sha="$GITHUB_SHA"

        if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
          github_sha="$PULL_REQUEST_SHA"
        fi

        if [[ "$git_sha" != "$github_sha" ]]; then
            echo "mismatch git sha \"$git_sha\" != \"$github_sha\""
            echo "GitHub context:"
            echo "$CONTEXT"
            echo
            echo "Last 20 commits:"
            git log -20
            exit 1
        fi
